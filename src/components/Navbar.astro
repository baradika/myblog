---
import Icon from "./Icon.astro";
import { name } from 'spectre:globals';

const path = Astro.url.pathname;
---
<nav id="main-nav">
  <a class="site-title" href="/">{name}</a>
  <ul id="nav-menu">
    <li>
      <a href="/blog" class:list={{ active: path.startsWith('/blog') }}>Blog</a>
    </li>
    <li class="nav-separator">/</li>
    <li>
      <a href="/projects" class:list={{ active: path.startsWith('/projects') }}>Projects</a>
    </li>
    <li class="nav-separator"></li>
  </ul>
  <button class="mobile-nav-toggle" aria-label="Toggle navigation">
    <Icon type="lucide" name="menu" width={24} height={24} class="menu-closed" />
    <Icon type="lucide" name="x" width={24} height={24} class="menu-open" />
  </button>
</nav>
<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const navToggle = document.querySelector('.mobile-nav-toggle');
    const nav = document.getElementById('main-nav');
    const navMenu = document.getElementById('nav-menu');
    
    // Mobile navigation toggle
    if (navToggle && nav && navMenu) {
      navToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navToggle.classList.toggle('active');
        nav.classList.toggle('active');
        navMenu.classList.toggle('active');
        document.body.classList.toggle('nav-open');
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!nav.contains(e.target) && nav.classList.contains('active')) {
          navToggle.classList.remove('active');
          nav.classList.remove('active');
          navMenu.classList.remove('active');
          document.body.classList.remove('nav-open');
        }
      });
    }

    // Search functionality
    const searchElement = document.getElementById('search');
    const results = document.getElementById('search-results');
    let focusIndex = -1;
    let pagefindInitialized = false;

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'k' && e.ctrlKey && searchElement) {
        e.preventDefault();
        searchElement.focus();
      }

      if (e.key === 'Escape' && searchElement && results) {
        searchElement.blur();
        results.classList.remove('active');
        focusIndex = -1;
      }

      if (results && results.classList.contains('active')) {
        const resultItems = document.querySelectorAll('#search-results a');

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          focusIndex++;
          
          if (focusIndex >= resultItems.length) {
            focusIndex = 0;
          }
          resultItems[focusIndex]?.focus();
        }

        if (e.key === 'ArrowUp') {
          e.preventDefault();
          focusIndex--;
          
          if (focusIndex < 0) {
            focusIndex = resultItems.length - 1;
          }
          resultItems[focusIndex]?.focus();
        }
      }
    });

    // Search focus/blur handling
    if (searchElement && results) {
      searchElement.addEventListener('focus', async () => {
        searchElement.placeholder = '';
        results.classList.add('active');
        
        if (!pagefindInitialized) {
          try {
            window.pagefind = await import("/pagefind/pagefind.js");
            await window.pagefind.init();
            pagefindInitialized = true;
          } catch (error) {
            console.error('Failed to initialize Pagefind:', error);
          }
        }
      });
      
      searchElement.addEventListener('blur', () => {
        handleTabletChange();
        setTimeout(() => {
          if (!document.activeElement?.closest('#search-results')) {
            results.classList.remove('active');
            focusIndex = -1;
          }
        }, 1);
      });

      results.addEventListener('focusout', (e) => {
        if (!e.relatedTarget?.closest('#search-results')) {
          results.classList.remove('active');
          focusIndex = -1;
        }
      });

      searchElement.addEventListener('input', async (e) => {
        if (!pagefindInitialized) return;

        results.innerHTML = '';
        let searchResultHtml = '';

        const search = await window.pagefind.search(e.target.value);

        let i = 0;
        for (const result of search.results) {
          i++;
          const data = await result.data();
          
          searchResultHtml += `
            <a href="${data.url}">
              <h3 class="no-mt">${data.meta.title}</h3>
              <p>${data.excerpt}</p>
            </a>
            ${i < search.results.length ? '<hr class="separator">' : ''}
          `;
        }

        if (search.results.length === 0 && e.target.value.length > 0) {
          results.innerHTML = '<p style="margin-top: 0;">No results found</p>';
        } else {
          results.innerHTML = searchResultHtml;
        }

        results.classList.add('active');
      });
    }

    // Responsive placeholder text
    const handleTabletChange = () => {
      if (searchElement) {
        if (window.matchMedia('(max-width: 640px)').matches) {
          searchElement.placeholder = 'Search';
        } else {
          searchElement.placeholder = 'Search (Ctrl+K)';
        }
      }
    }

    handleTabletChange();
    window.addEventListener('resize', handleTabletChange);
  });
</script>
<style>
  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'Geist Mono', monospace;
    z-index: 50;
    position: relative;
  }

  .site-title {
    font-weight: 800;
    text-decoration: none;
    font-size: 1.25em;
    z-index: 2;
  }

  nav ul {
    display: flex;
    gap: 1rem;
    margin: 0;
    padding: 0;
    list-style-type: none;
    align-items: center;
  }

  nav ul li {
    position: relative;
  }

  nav a {
    color: inherit;
    text-decoration: none;
    padding: .25rem .5rem;
  }

  nav a:hover, nav a:focus-visible, nav a.active {
    background-color: var(--primary);
    outline: none;
  }

  #search {
    background: none;
    border: none;
    outline: none;
    padding: .25rem .5rem;
    width: 160px;
  }

  #search::placeholder {
    color: white;
  }

  #search:focus {
    background-color: var(--primary);
  }

  #search-results {
    position: absolute;
    top: calc(100% + .5rem);
    right: 0;
    background-color: #252525;
    border: 1px solid var(--primary);
    display: none;
    width: 200%;
    z-index: 10;
    padding: .5rem;
  }

  #search-results.active:has(*) {
    display: block;
  }

  .mobile-nav-toggle {
    display: none;
    width: 40px;
    height: 40px;
    background-color: #121212;
    border: 1px solid #353535;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
  }

  .menu-open {
    display: none;
  }

  .mobile-nav-toggle.active .menu-open {
    display: flex;
  }

  .mobile-nav-toggle.active .menu-closed {
    display: none;
  }

  @media screen and (max-width: 640px) {
    body.nav-open {
      overflow: hidden;
    }

    nav {
      padding: 0 1rem;
      padding-top: 1rem;
    }

    .mobile-nav-toggle {
      display: flex;
    }

    .nav-separator {
      display: none;
    }

    #nav-menu {
      flex-direction: column;
      gap: 0;
      position: fixed;
      width: 100%;
      top: calc(1rem + 40px);
      left: 0;
      padding: 1rem;
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      user-select: none;
      height: calc(100vh - 1rem - 40px);
      align-items: start;
      background-color: #181818;
      margin: 0;
      transform: translateX(-100%);
      overflow-y: auto;
    }

    #nav-menu.active {
      opacity: 1;
      pointer-events: all;
      transform: translateX(0);
    }

    #nav-menu li {
      width: 100%;
      padding: 0;
      margin: 0;
      border-bottom: 1px solid #353535;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: translateX(-20px);
      opacity: 0;
    }

    #nav-menu.active li {
      transform: translateX(0);
      opacity: 1;
    }

    #nav-menu li:first-child {
      border-top: 1px solid #353535;
    }

    #nav-menu li a {
      display: block;
      padding: 1rem;
      width: 100%;
      font-size: 1.125em;
    }

    /* Staggered animation for menu items */
    #nav-menu.active li:nth-child(1) { transition-delay: 0.1s; }
    #nav-menu.active li:nth-child(2) { transition-delay: 0.15s; }
    #nav-menu.active li:nth-child(3) { transition-delay: 0.2s; }
    #nav-menu.active li:nth-child(4) { transition-delay: 0.25s; }
  }
</style>
<style is:global>
  #search-results a {
    display: block;
    text-decoration: none;
    color: white !important;
    padding: .5rem;
  }

  #search-results a:hover, #search-results a:focus-visible {
    background-color: var(--primary);
    outline: none;
  }

  #search-results a:hover mark, #search-results a:focus-visible mark {
    background-color: #ffffff;
    color: #000000;
  }

  #search-results a h3 {
    margin-bottom: .5rem;
  }

  #search-results a p {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  #search-results mark {
    background-color: var(--primary);
    color: white;
  }

  .separator {
    margin: .5rem .5rem;
    border: none;
    height: 1px;
    background-color: #353535;
  }
</style>